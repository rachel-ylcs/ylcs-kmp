name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  package-android:
    name: Package Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: gradle
          cache-dependency-path: |
            ./*.gradle*
            ./**/gradle-wrapper.properties

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Build
        run: ./gradlew ylcs-app:androidApp:androidPublish

      - name: Rename
        run: |
          cd outputs
          mv ylcs.apk "[Android]é“¶ä¸´èŒ¶èˆ${{ github.ref_name }}.apk"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: outputs/*.apk

  package-ios:
    name: Package iOS
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: gradle
          cache-dependency-path: |
            ./*.gradle*
            ./**/gradle-wrapper.properties

      - name: Build
        run: |
          ./gradlew ylcs-app:shared:generateDummyFramework
          # xcodebuild build -workspace ./ylcs-app/iosApp/iosApp.xcworkspace -scheme iosApp
          xcodebuild archive -workspace ./ylcs-app/iosApp/iosApp.xcworkspace -scheme iosApp -archivePath ./outputs/iosApp
          # xcodebuild -exportArchive -archivePath ./outputs/iosApp.xcarchive -exportPath outputs/ylcs -exportOptionsPlist ./ylcs-app/iosApp/ExportOptions.plist
          mkdir -p outputs/Payload
          cp -r outputs/iosApp.xcarchive/Products/Applications/ylcs.app outputs/Payload/
          cd outputs
          zip -r "[iOS]é“¶ä¸´èŒ¶èˆ${{ github.ref_name }}.ipa" Payload

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: outputs/*.ipa

  package-windows:
    name: Package Windows
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: gradle
          cache-dependency-path: |
            ./*.gradle*
            ./**/gradle-wrapper.properties

      - name: Setup MSVC
        uses: TheMrMilchmann/setup-msvc-dev@v4
        with:
          arch: x64
          export-path-to-vs: VS_PATH

      - name: Build
        run: |
          ./gradlew ylcs-app:desktopApp:desktopPublish

      - name: Compress
        run: |
          cd outputs
          7z a "[Windows]é“¶ä¸´èŒ¶èˆ${{ github.ref_name }}.zip" ylcs

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: outputs/*.zip

  package-linux:
    name: Package Linux
    # ç”¨å¤ªæ–°çš„ Ubuntu ä¼šå¯¼è‡´ native åº“é“¾æ¥çš„ glibc ç‰ˆæœ¬è¿‡é«˜ï¼Œå¯¼è‡´æ— æ³•åœ¨è¾ƒæ—§çš„ Linux ä¸Šè¿è¡Œ
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: gradle
          cache-dependency-path: |
            ./*.gradle*
            ./**/gradle-wrapper.properties

      - name: Build
        run: |
          ./gradlew ylcs-app:desktopApp:desktopPublish

      - name: Compress
        run: |
          cd outputs
          tar -czf "[Linux]é“¶ä¸´èŒ¶èˆ${{ github.ref_name }}.tar.gz" ylcs

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: outputs/*.tar.gz

  package-macos:
    name: Package macOS
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: gradle
          cache-dependency-path: |
            ./*.gradle*
            ./**/gradle-wrapper.properties

      - name: Build
        run: |
          ./gradlew ylcs-app:desktopApp:desktopPublish

      - name: Compress
        run: |
          cd outputs
          zip -r "[macOS]é“¶ä¸´èŒ¶èˆ${{ github.ref_name }}.zip" ylcs.app

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: outputs/*.zip

  package-web:
    name: Package Web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: gradle
          cache-dependency-path: |
            ./*.gradle*
            ./**/gradle-wrapper.properties

      - name: Build
        run: ./gradlew ylcs-app:webApp:webPublish

      - name: Compress
        run: |
          cd outputs
          zip -r "[Web]é“¶ä¸´èŒ¶èˆ${{ github.ref_name }}.zip" web

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: outputs/*.zip

  package-server:
    name: Package Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: gradle
          cache-dependency-path: |
            ./*.gradle*
            ./**/gradle-wrapper.properties

      - name: Build
        run: ./gradlew ylcs-app:server:serverPublish

      - name: Compress
        run: |
          cd outputs
          zip -r "[Server]é“¶ä¸´èŒ¶èˆ${{ github.ref_name }}.zip" ylcs.jar

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: server
          path: outputs/*.zip

  publish-release:
    name: Publish Release
    if: ${{ always() }}
    needs: [package-android, package-ios, package-windows, package-linux, package-macos, package-web, package-server]
    runs-on: ubuntu-latest
    permissions:
      contents: write # å‘å¸ƒ Release éœ€è¦å†™æƒé™
    steps:
      - name: Generate Changelog
        uses: mikepenz/release-changelog-builder-action@v5
        id: changelog
        with:
          mode: "COMMIT"
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n## è´¡çŒ®è€…\n#{{CONTRIBUTORS}}",
              "categories": [
                {
                    "title": "## æ–°åŠŸèƒ½",
                    "labels": ["feat", "feature"]
                },
                {
                    "title": "## UI",
                    "labels": ["style", "ui"]
                },
                {
                    "title": "## ä¿®å¤",
                    "labels": ["fix", "bug"]
                },
                {
                    "title": "## ä¼˜åŒ–&é‡æ„",
                    "labels": ["imporve", "perf", "refactor"]
                },
                {
                    "title": "## æ–‡æ¡£",
                    "labels": ["docs", "doc"]
                },
                {
                    "title": "## æ‚é¡¹",
                    "labels": ["build", "chore", "ci", "update", "revert", "rollback"]
                }
              ],
              "label_extractor": [
                {
                  "pattern": "^(build|chore|ci|docs?|feat|feature|fix|bug|imporve|perf|refactor|update|revert|rollback|style|ui){1}(\\([\\w\\-\\.]+\\))?(!)?:(.*)",
                  "on_property": "title",
                  "target": "$1"
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: é“¶ä¸´èŒ¶èˆ ${{ github.ref_name }} å‘å¸ƒğŸ‰ğŸ‰ğŸ‰
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          preserve_order: true
          files: |
            artifacts/android/*
            artifacts/ios/*
            artifacts/windows/*
            artifacts/macos/*
            artifacts/linux/*
            artifacts/web/*
            artifacts/server/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}